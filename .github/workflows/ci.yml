name: CI
on:
  pull_request:
  merge_group:
concurrency:
  group: ci-${{ github.event_name == 'pull_request' && github.head_ref || github.sha }}
  cancel-in-progress: true
permissions:
  contents: read
  pull-requests: read
jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest
    env:
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Set Up Node.js
        uses: actions/setup-node@v5
        with:
          node-version-file: .nvmrc
          cache: npm
      - name: Install Dependencies
        run: npm ci
      - name: Check Dependencies
        run: npx expo install --check
      - name: Run Expo Doctor
        run: npx expo-doctor
      - name: Run Prettier
        run: npm run format:check
      - name: Get Files Changed (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require("node:fs/promises");
            const nodePath = require("node:path");

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const paths = files.map(file => file.filename);

            const outPath = nodePath.join(process.env.GITHUB_WORKSPACE, "files-changed.json");
            await fs.writeFile(outPath, JSON.stringify(paths, null, 2));

            core.exportVariable("FILES_CHANGED_JSON", outPath);
      - name: Get Files Changed (Merge Group)
        if: ${{ github.event_name == 'merge_group' }}
        run: |
          set -euo pipefail

          base_ref="${{ github.event.merge_group.base_ref }}"
          base_sha="${{ github.event.merge_group.base_sha }}"
          head_sha="${{ github.sha }}"

          echo "Base ref: $base_ref"
          echo "Base SHA: $base_sha"
          echo "Head SHA: $head_sha"

          git fetch --no-tags --prune --depth=200 origin "$base_ref"

          git diff --name-only --diff-filter=ACMRT "$base_sha" "$head_sha" |
            jq -Rsc 'split("\n")[:-1]' >files-changed.json

          echo "FILES_CHANGED_JSON=$PWD/files-changed.json" >>"$GITHUB_ENV"
      - name: Run ESLint
        run: npm run lint -- -f json -o eslint-report.json || true
      - name: Run tsc
        run: node ./scripts/ci-tsc-report.mjs > tsc-report.json || true
      - name: Report
        run: |
          node ./scripts/ci-report-problems.mjs "$FILES_CHANGED_JSON" eslint-report.json tsc-report.json
      - name: Run Tests
        run: npm run test:ci
      - name: Decide Build
        id: build_gate
        run: |
          set -euo pipefail

          need=false

          if [ "${{ github.event_name }}" = "merge_group" ]; then
            need=true
          else
            files_changed=$(jq -r '.[]' "$FILES_CHANGED_JSON")

            for f in $files_changed; do
              case "$f" in
              app.json | eas.json | package.json | package-lock.json)
                need=true
                ;;
              esac
            done
          fi

          echo "need=$need" >>"$GITHUB_OUTPUT"
      - name: Build
        if: ${{ steps.build_gate.outputs.need == 'true' }}
        uses: ./.github/actions/build
# Commented out because we won't be using EAS for now, but build on GitHub
# EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
# - name: Set Up Expo
#   uses: expo/expo-github-action@v8
#   with:
#     token: ${{ env.EXPO_TOKEN }}
#     packager: npm
#     expo-version: latest
#     eas-version: latest
# - name: Build Android Preview
#   run: eas build -p android -e preview --non-interactive --wait
