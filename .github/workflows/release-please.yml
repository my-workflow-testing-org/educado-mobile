name: Release Please
on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.release-please.outputs.upload_url }}
      releases_created: ${{ steps.release-please.outputs.releases_created }}
      tag_name: ${{ steps.release-please.outputs.tag_name }}
    steps:
      - name: Generate Token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.EDUCADO_BOT_CLIENT_ID }}
          private-key: ${{ secrets.EDUCADO_BOT_PEM }}
      - name: Release Please Action
        id: release-please
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38
        with:
          token: ${{ steps.generate-token.outputs.token }}
          manifest-file: .release-please-manifest.json
          config-file: release-please-config.json
      - name: Log Outputs
        run: |
          echo "Upload URL: ${{ steps.release-please.outputs.upload_url }}"
          echo "Releases Created: ${{ steps.release-please.outputs.releases_created }}"

  build-and-upload:
    if: needs.release-please.outputs.releases_created == 'true'
    runs-on: ubuntu-latest
    needs: release-please
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Set Up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - name: Cache node_modules
        id: npm-cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - name: Install Dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci
      - name: Check Dependencies
        run: npx expo install --check
      - name: Prebuild
        shell: bash
        run: npx expo prebuild --platform android --no-install
      - name: Set Up Java
        uses: actions/setup-java@v5
        with:
          java-version: 20
          distribution: temurin
      - name: Set Up Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2
      - name: Generate Token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.EDUCADO_BOT_CLIENT_ID }}
          private-key: ${{ secrets.EDUCADO_BOT_PEM }}
      - name: Build Android Artifacts
        shell: bash
        working-directory: android
        run: ./gradlew :app:assembleRelease :app:bundleRelease --no-daemon --stacktrace
      - name: Upload Release Assets
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          token: ${{ steps.generate-token.outputs.token }}
          files: |
            android/app/build/outputs/apk/release/app-release.apk
            android/app/build/outputs/bundle/release/app-release.aab
      - name: Delete Release Branches
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const prefix = 'heads/release-please--branches--';
            const refs = await github.paginate(
              github.rest.git.listMatchingRefs,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: prefix,
              }
            );

            if (!refs.length) {
              core.info('No release-please branches found to delete.');
              return;
            }

            for (const { ref } of refs) {
              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref,
                });
                core.info(`Deleted ${ref}`);
              } catch (error) {
                if (error.status === 404 || error.status === 422) {
                  core.info(`Branch ${ref} already absent, skipping.`);
                } else {
                  throw error;
                }
              }
            }
